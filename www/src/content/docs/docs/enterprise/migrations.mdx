---
title: Migrations
description: Database setup and CLI for enterprise features.
---

Enterprise features require a Cloudflare D1 database. The OpenAuth CLI handles schema setup automatically.

## CLI Usage

```bash
# Apply schema (auto-detects database from wrangler config)
npx openauth migrate

# Specify database name
npx openauth migrate my-auth-db

# Local development
npx openauth migrate --local

# Remote (production) database
npx openauth migrate --remote

# Combine options
npx openauth migrate my-auth-db --remote

# Custom config file
npx openauth migrate -c wrangler.qa.json --remote
```

## Idempotent Schema

The schema uses `CREATE TABLE IF NOT EXISTS` and `CREATE INDEX IF NOT EXISTS` throughout. This means:

- **Safe to run multiple times** - No errors on re-run
- **No migration tracking needed** - Schema is self-healing
- **Simple deployment** - Just run `npx openauth migrate` in your build

```json title="package.json"
{
  "scripts": {
    "build": "openauth migrate --remote && tsc && wrangler deploy",
    "dev": "openauth migrate --local && wrangler dev"
  }
}
```

## Wrangler Configuration

The CLI supports multiple configuration formats:

- `wrangler.toml` (checked first)
- `wrangler.json`
- `wrangler.jsonc` (JSON with comments)

### wrangler.toml

```toml title="wrangler.toml"
name = "my-auth-service"
main = "src/index.ts"

[[d1_databases]]
binding = "DB"
database_name = "my-auth-db"
database_id = "your-database-id"
```

### wrangler.json / wrangler.jsonc

```json title="wrangler.json"
{
  "name": "my-auth-service",
  "main": "src/index.ts",
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "my-auth-db",
      "database_id": "your-database-id"
    }
  ]
}
```

## Database Schema

All tables are created by a single schema file (`001_schema.sql`).

### Tenants

```sql
CREATE TABLE tenants (
  id TEXT PRIMARY KEY,
  domain TEXT UNIQUE,
  name TEXT NOT NULL,
  status TEXT DEFAULT 'active',
  branding TEXT,
  settings TEXT,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);
```

### OAuth Clients

```sql
CREATE TABLE oauth_clients (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  name TEXT NOT NULL,
  client_secret_hash TEXT,
  grant_types TEXT DEFAULT '[]',
  scopes TEXT DEFAULT '[]',
  redirect_uris TEXT DEFAULT '[]',
  metadata TEXT DEFAULT '{}',
  enabled INTEGER DEFAULT 1,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  rotated_at INTEGER,
  previous_secret_hash TEXT,
  previous_secret_expires_at INTEGER,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);
```

### Browser Sessions

```sql
CREATE TABLE browser_sessions (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  last_activity INTEGER NOT NULL,
  user_agent TEXT,
  ip_address TEXT,
  version INTEGER DEFAULT 1,
  active_user_id TEXT,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);
```

### Account Sessions

```sql
CREATE TABLE account_sessions (
  id TEXT PRIMARY KEY,
  browser_session_id TEXT NOT NULL,
  user_id TEXT NOT NULL,
  is_active INTEGER DEFAULT 0,
  authenticated_at INTEGER NOT NULL,
  expires_at INTEGER NOT NULL,
  subject_type TEXT NOT NULL,
  subject_properties TEXT,
  refresh_token TEXT NOT NULL,
  client_id TEXT NOT NULL,
  FOREIGN KEY (browser_session_id) REFERENCES browser_sessions(id) ON DELETE CASCADE
);
```

### Users

```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  email TEXT NOT NULL,
  name TEXT,
  metadata TEXT,
  status TEXT DEFAULT 'active',
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  last_login_at INTEGER,
  deleted_at INTEGER,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX idx_users_tenant_email
  ON users(tenant_id, email) WHERE deleted_at IS NULL;
```

### User Identities

```sql
CREATE TABLE user_identities (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  tenant_id TEXT NOT NULL,
  provider TEXT NOT NULL,
  provider_user_id TEXT NOT NULL,
  provider_data TEXT,
  created_at INTEGER NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### Identity Providers

```sql
CREATE TABLE identity_providers (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  type TEXT NOT NULL,
  name TEXT NOT NULL,
  display_name TEXT NOT NULL,
  client_id TEXT,
  client_secret_encrypted TEXT,
  client_secret_iv TEXT,
  config TEXT DEFAULT '{}',
  enabled INTEGER DEFAULT 1,
  display_order INTEGER DEFAULT 0,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  UNIQUE(tenant_id, name),
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);
```

### RBAC Tables

```sql
CREATE TABLE rbac_apps (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  tenant_id TEXT NOT NULL,
  description TEXT,
  created_at INTEGER NOT NULL
);

CREATE TABLE rbac_roles (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  tenant_id TEXT NOT NULL,
  description TEXT,
  is_system_role INTEGER DEFAULT 0,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

CREATE TABLE rbac_permissions (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  app_id TEXT NOT NULL,
  description TEXT,
  resource TEXT NOT NULL,
  action TEXT NOT NULL,
  created_at INTEGER NOT NULL
);

CREATE TABLE rbac_role_permissions (
  role_id TEXT NOT NULL,
  permission_id TEXT NOT NULL,
  granted_at INTEGER NOT NULL,
  granted_by TEXT NOT NULL,
  PRIMARY KEY (role_id, permission_id)
);

CREATE TABLE rbac_user_roles (
  user_id TEXT NOT NULL,
  role_id TEXT NOT NULL,
  tenant_id TEXT NOT NULL,
  assigned_at INTEGER NOT NULL,
  expires_at INTEGER,
  assigned_by TEXT NOT NULL,
  PRIMARY KEY (user_id, role_id, tenant_id)
);
```

### Permission Check View

```sql
CREATE VIEW user_permissions AS
SELECT DISTINCT
  ur.user_id,
  ur.tenant_id,
  p.app_id,
  p.name AS permission_name,
  p.resource,
  p.action,
  r.name AS role_name,
  r.is_system_role,
  ur.expires_at
FROM rbac_user_roles ur
INNER JOIN rbac_roles r ON ur.role_id = r.id
INNER JOIN rbac_role_permissions rp ON r.id = rp.role_id
INNER JOIN rbac_permissions p ON rp.permission_id = p.id
WHERE (ur.expires_at IS NULL OR ur.expires_at > strftime('%s', 'now') * 1000);
```

## Manual Migration

If you prefer manual control, execute the schema directly with wrangler:

```bash
# Local
wrangler d1 execute my-auth-db --local \
  --file=./node_modules/@openauthjs/openauth/src/migrations/001_schema.sql

# Remote
wrangler d1 execute my-auth-db --remote \
  --file=./node_modules/@openauthjs/openauth/src/migrations/001_schema.sql
```

## Troubleshooting

### "wrangler CLI not found"

Install wrangler globally:

```bash
npm install -g wrangler
```

### "No database name provided"

Either specify the database name or ensure your wrangler config has a D1 database entry with `database_name`.

### Schema errors

The schema is idempotent. If you encounter errors, check:

1. Database connectivity (`wrangler d1 list`)
2. Permissions (must have D1 access)
3. Config file path (`-c wrangler.qa.json`)
