---
title: Migrations
description: Database setup and CLI for enterprise features.
---

Enterprise features require a Cloudflare D1 database. The OpenAuth CLI handles migrations automatically.

## CLI Usage

```bash
# Run migrations (auto-detects database from wrangler config)
npx openauth migrate

# Specify database name
npx openauth migrate my-auth-db

# Local development
npx openauth migrate --local

# Remote (production) database
npx openauth migrate --remote

# Combine options
npx openauth migrate my-auth-db --local
```

## Migration Tracking

The CLI tracks applied migrations in a `_openauth_migrations` table. This allows:
- **Safe re-runs** - Running migrate multiple times won't cause errors
- **Incremental updates** - Only new migrations are applied
- **Audit trail** - Track when each migration was applied

```bash
# If you have an existing database that was migrated before tracking existed:
npx openauth migrate --mark-applied

# This marks all migrations as "applied" without executing them
```

## Build Integration

Add migrations to your build script for automatic setup:

```json title="package.json"
{
  "scripts": {
    "build": "openauth migrate && tsc && wrangler deploy",
    "dev": "openauth migrate --local && wrangler dev"
  }
}
```

## Wrangler Configuration

The CLI supports multiple configuration formats:

- `wrangler.toml` (checked first)
- `wrangler.json`
- `wrangler.jsonc` (JSON with comments)

### wrangler.toml

```toml title="wrangler.toml"
name = "my-auth-service"
main = "src/index.ts"

[[d1_databases]]
binding = "DB"
database_name = "my-auth-db"
database_id = "your-database-id"
```

### wrangler.json / wrangler.jsonc

```json title="wrangler.json"
{
  "name": "my-auth-service",
  "main": "src/index.ts",
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "my-auth-db",
      "database_id": "your-database-id"
    }
  ]
}
```

The CLI reads `database_name` from the first D1 database entry when no database is specified.

## Migration Files

The CLI executes these SQL files in order:

| File | Description |
|------|-------------|
| `000_migration_tracking.sql` | Migration tracking table (auto-created) |
| `001_oauth_clients.sql` | OAuth clients with tenant isolation & secret rotation |
| `002_add_tenant_support.sql` | Tenant management tables |
| `003_session_management.sql` | Session storage tables |
| `004_rbac_schema.sql` | RBAC permissions, roles, assignments |
| `005_user_management.sql` | Users and identity linking tables |
| `006_identity_providers.sql` | Dynamic provider configurations |

All migrations use `CREATE TABLE IF NOT EXISTS` for idempotency.

## Manual Migration

If you prefer manual control, execute migrations directly with wrangler:

```bash
# Local
wrangler d1 execute my-auth-db --local \
  --file=./node_modules/@al-ummah-now/openauth/src/migrations/001_oauth_clients.sql

# Remote
wrangler d1 execute my-auth-db \
  --file=./node_modules/@al-ummah-now/openauth/src/migrations/001_oauth_clients.sql
```

## Database Schema Overview

### OAuth Clients

```sql
CREATE TABLE oauth_clients (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  name TEXT NOT NULL,
  client_secret_hash TEXT,
  grant_types TEXT,           -- JSON array
  scopes TEXT,                -- JSON array
  redirect_uris TEXT,         -- JSON array
  metadata TEXT DEFAULT '{}', -- JSON object
  enabled INTEGER DEFAULT 1,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  rotated_at INTEGER,
  previous_secret_hash TEXT,
  previous_secret_expires_at INTEGER
);

CREATE UNIQUE INDEX idx_oauth_clients_tenant_name ON oauth_clients(tenant_id, name);
```

### Tenants

```sql
CREATE TABLE tenants (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  domain TEXT UNIQUE,
  branding TEXT,           -- JSON object
  status TEXT DEFAULT 'active',
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);
```

### Sessions

```sql
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  tenant_id TEXT,
  user_id TEXT NOT NULL,
  data TEXT,               -- Encrypted JSON
  expires_at INTEGER NOT NULL,
  created_at INTEGER NOT NULL
);
```

### RBAC

```sql
CREATE TABLE rbac_permissions (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  created_at INTEGER NOT NULL
);

CREATE TABLE rbac_roles (
  id TEXT NOT NULL,
  tenant_id TEXT NOT NULL,
  name TEXT NOT NULL,
  permissions TEXT,        -- JSON array
  PRIMARY KEY (id, tenant_id)
);

CREATE TABLE rbac_user_roles (
  user_id TEXT NOT NULL,
  role_id TEXT NOT NULL,
  tenant_id TEXT NOT NULL,
  PRIMARY KEY (user_id, role_id, tenant_id)
);
```

### Users

```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  email TEXT NOT NULL,
  name TEXT,
  metadata TEXT,              -- JSON object
  status TEXT DEFAULT 'active',
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  last_login_at INTEGER,
  deleted_at INTEGER,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);

-- Unique email per tenant (only for non-deleted users)
CREATE UNIQUE INDEX idx_users_tenant_email
    ON users(tenant_id, email) WHERE deleted_at IS NULL;
```

### User Identities

```sql
CREATE TABLE user_identities (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  tenant_id TEXT NOT NULL,
  provider TEXT NOT NULL,
  provider_user_id TEXT NOT NULL,
  provider_data TEXT,         -- JSON object
  created_at INTEGER NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX idx_identities_provider
    ON user_identities(tenant_id, provider, provider_user_id);
```

### Identity Providers

```sql
CREATE TABLE identity_providers (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  type TEXT NOT NULL,         -- google, github, facebook, microsoft, oidc, etc.
  name TEXT NOT NULL,         -- Unique name within tenant (used in URLs)
  display_name TEXT NOT NULL, -- Human-readable name for UI
  client_id TEXT,
  client_secret_encrypted TEXT, -- AES-256-GCM encrypted
  client_secret_iv TEXT,        -- Initialization vector (base64)
  config TEXT DEFAULT '{}',     -- Provider-specific configuration (JSON)
  enabled INTEGER DEFAULT 1,
  display_order INTEGER DEFAULT 0,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  UNIQUE(tenant_id, name),
  FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);
```

## Troubleshooting

### "wrangler CLI not found"

Install wrangler globally:

```bash
npm install -g wrangler
```

### "No database name provided"

Either specify the database name or ensure your wrangler config has a D1 database entry with `database_name`. Supported config files: `wrangler.toml`, `wrangler.json`, `wrangler.jsonc`.

### Migration errors

With migration tracking enabled, re-running migrations is safe. If you encounter "duplicate column" errors on an existing database:

```bash
# Mark all migrations as applied without re-executing them
npx openauth migrate --mark-applied --local
```

This is useful when upgrading from an older version that didn't track migrations.
