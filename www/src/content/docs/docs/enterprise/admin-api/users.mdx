---
title: Users API
description: Create, update, and manage user accounts programmatically.
---

The Users API provides endpoints for managing user accounts, including creation, updates, suspension, deletion, and identity linking.

## User Model

A user represents an authenticated identity in your system. Users are scoped to a tenant and can have multiple linked identities from different providers.

```ts title="user-types.ts"
interface User {
  id: string                          // Unique identifier (e.g., "usr_abc123def456")
  tenant_id: string                   // Tenant this user belongs to
  email: string                       // Primary email address (unique per tenant)
  name: string | null                 // Display name
  metadata: Record<string, unknown> | null  // Custom application data
  status: "active" | "suspended" | "deleted"
  created_at: number                  // Unix timestamp (milliseconds)
  updated_at: number                  // Unix timestamp (milliseconds)
  last_login_at: number | null        // Last successful login timestamp
  deleted_at: number | null           // Soft delete timestamp
  password_reset_required: boolean    // User must reset password on next login
}
```

### User Status

| Status | Description |
|--------|-------------|
| `active` | User can authenticate and access resources |
| `suspended` | User is temporarily blocked from authentication |
| `deleted` | User has been soft-deleted and cannot authenticate |

### User IDs

User IDs are prefixed with `usr_` followed by a 32-character unique identifier:

```
usr_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
```

## Identity Linking

Users can have multiple linked identities from different authentication providers. This enables "Login with Google" and "Login with GitHub" to point to the same user account.

```ts title="identity-types.ts"
interface UserIdentity {
  id: string              // Identity ID (e.g., "idt_xyz789")
  user_id: string         // Parent user ID
  tenant_id: string       // Tenant scope
  provider: string        // Provider name (e.g., "google", "github")
  provider_user_id: string // User ID from the provider
  provider_data: Record<string, unknown> | null  // Provider-specific data
  created_at: number      // When the identity was linked
}
```

**Example:** A user with linked Google and GitHub identities:

```json title="user-with-identities.json"
{
  "id": "usr_abc123",
  "email": "alice@example.com",
  "name": "Alice Smith",
  "status": "active",
  "identities": [
    {
      "id": "idt_001",
      "provider": "google",
      "provider_user_id": "118234567890123456789",
      "provider_data": {
        "email": "alice@gmail.com",
        "picture": "https://..."
      }
    },
    {
      "id": "idt_002",
      "provider": "github",
      "provider_user_id": "12345678",
      "provider_data": {
        "login": "alicesmith",
        "avatar_url": "https://..."
      }
    }
  ]
}
```

---

## API Endpoints

### List Users

Retrieve a paginated list of users with optional filtering.

```http
GET /api/users
```

**Required Scope:** `users:read`

**Query Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `limit` | number | 50 | Items per page (max: 100) |
| `cursor` | string | - | Pagination cursor |
| `status` | string | - | Filter by status (`active`, `suspended`) |
| `email` | string | - | Filter by email (partial match) |
| `sort_by` | string | `created_at` | Sort field (`created_at`, `updated_at`, `email`, `name`) |
| `sort_order` | string | `desc` | Sort direction (`asc`, `desc`) |

**Request:**

```ts title="list-users.ts"
const response = await fetch(
  "https://auth.example.com/api/users?limit=25&status=active&sort_by=created_at",
  {
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  }
)
```

**Response:**

```json title="list-users-response.json"
{
  "users": [
    {
      "id": "usr_abc123",
      "tenant_id": "tenant_001",
      "email": "alice@example.com",
      "name": "Alice Smith",
      "metadata": { "department": "Engineering" },
      "status": "active",
      "created_at": 1699574400000,
      "updated_at": 1699574400000,
      "last_login_at": 1699660800000,
      "deleted_at": null
    }
  ],
  "next_cursor": "usr_xyz789",
  "has_more": true,
  "total_count": 150
}
```

---

### Create User

Create a new user account.

```http
POST /api/users
```

**Required Scope:** `users:write`

**Request Body:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `email` | string | Yes | Email address (max 255 chars) |
| `name` | string | No | Display name |
| `metadata` | object | No | Custom application data |

**Request:**

```ts title="create-user.ts"
const response = await fetch("https://auth.example.com/api/users", {
  method: "POST",
  headers: {
    Authorization: `Bearer ${accessToken}`,
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    email: "bob@example.com",
    name: "Bob Johnson",
    metadata: {
      department: "Sales",
      employeeId: "EMP-12345",
    },
  }),
})
```

**Response (201 Created):**

```json title="create-user-response.json"
{
  "id": "usr_def456",
  "tenant_id": "tenant_001",
  "email": "bob@example.com",
  "name": "Bob Johnson",
  "metadata": {
    "department": "Sales",
    "employeeId": "EMP-12345"
  },
  "status": "active",
  "created_at": 1699747200000,
  "updated_at": 1699747200000,
  "last_login_at": null,
  "deleted_at": null
}
```

**Error (409 Conflict - Email Already Exists):**

```json
{
  "error": "email_already_exists",
  "error_description": "Email 'bob@example.com' is already registered"
}
```

---

### Get User

Retrieve a single user with their linked identities.

```http
GET /api/users/:id
```

**Required Scope:** `users:read`

**Request:**

```ts title="get-user.ts"
const response = await fetch(
  "https://auth.example.com/api/users/usr_abc123",
  {
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  }
)
```

**Response:**

```json title="get-user-response.json"
{
  "id": "usr_abc123",
  "tenant_id": "tenant_001",
  "email": "alice@example.com",
  "name": "Alice Smith",
  "metadata": { "department": "Engineering" },
  "status": "active",
  "created_at": 1699574400000,
  "updated_at": 1699574400000,
  "last_login_at": 1699660800000,
  "deleted_at": null,
  "identities": [
    {
      "id": "idt_001",
      "user_id": "usr_abc123",
      "tenant_id": "tenant_001",
      "provider": "google",
      "provider_user_id": "118234567890123456789",
      "provider_data": {
        "email": "alice@gmail.com",
        "name": "Alice Smith"
      },
      "created_at": 1699574400000
    }
  ]
}
```

**Error (404 Not Found):**

```json
{
  "error": "user_not_found",
  "error_description": "User 'usr_abc123' not found"
}
```

---

### Update User

Update user properties. Only provided fields are updated.

```http
PATCH /api/users/:id
```

**Required Scope:** `users:write`

**Request Body:**

| Field | Type | Description |
|-------|------|-------------|
| `email` | string | New email address |
| `name` | string \| null | Display name (null to clear) |
| `metadata` | object \| null | Custom data (null to clear) |

**Request:**

```ts title="update-user.ts"
const response = await fetch(
  "https://auth.example.com/api/users/usr_abc123",
  {
    method: "PATCH",
    headers: {
      Authorization: `Bearer ${accessToken}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      name: "Alice Johnson",
      metadata: {
        department: "Engineering",
        title: "Senior Engineer",
      },
    }),
  }
)
```

**Response:**

```json title="update-user-response.json"
{
  "id": "usr_abc123",
  "tenant_id": "tenant_001",
  "email": "alice@example.com",
  "name": "Alice Johnson",
  "metadata": {
    "department": "Engineering",
    "title": "Senior Engineer"
  },
  "status": "active",
  "created_at": 1699574400000,
  "updated_at": 1699833600000,
  "last_login_at": 1699660800000,
  "deleted_at": null
}
```

**Error (403 Forbidden - Deleted User):**

```json
{
  "error": "user_deleted",
  "error_description": "Cannot update a deleted user"
}
```

---

### Delete User

Soft-delete a user. The user record is retained but marked as deleted, and all active sessions are revoked.

```http
DELETE /api/users/:id
```

**Required Scope:** `users:delete`

**Request:**

```ts title="delete-user.ts"
const response = await fetch(
  "https://auth.example.com/api/users/usr_abc123",
  {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  }
)
```

**Response (204 No Content):**

No response body on success.

**Behavior:**

1. User status is set to `deleted`
2. `deleted_at` timestamp is recorded
3. Email lookup index is removed (email can be reused)
4. All active sessions are revoked
5. User cannot authenticate

---

### Suspend User

Temporarily suspend a user, preventing authentication. All active sessions are revoked.

```http
POST /api/users/:id/suspend
```

**Required Scope:** `users:write`

**Request:**

```ts title="suspend-user.ts"
const response = await fetch(
  "https://auth.example.com/api/users/usr_abc123/suspend",
  {
    method: "POST",
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  }
)
```

**Response:**

```json title="suspend-user-response.json"
{
  "user": {
    "id": "usr_abc123",
    "tenant_id": "tenant_001",
    "email": "alice@example.com",
    "name": "Alice Smith",
    "status": "suspended",
    "created_at": 1699574400000,
    "updated_at": 1699920000000,
    "last_login_at": 1699660800000,
    "deleted_at": null
  },
  "revoked_sessions": 3
}
```

**Error (403 Forbidden - Already Deleted):**

```json
{
  "error": "user_deleted",
  "error_description": "Cannot suspend a deleted user"
}
```

---

### Unsuspend User

Restore a suspended user to active status.

```http
POST /api/users/:id/unsuspend
```

**Required Scope:** `users:write`

**Request:**

```ts title="unsuspend-user.ts"
const response = await fetch(
  "https://auth.example.com/api/users/usr_abc123/unsuspend",
  {
    method: "POST",
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  }
)
```

**Response:**

```json title="unsuspend-user-response.json"
{
  "id": "usr_abc123",
  "tenant_id": "tenant_001",
  "email": "alice@example.com",
  "name": "Alice Smith",
  "status": "active",
  "created_at": 1699574400000,
  "updated_at": 1699920000000,
  "last_login_at": 1699660800000,
  "deleted_at": null
}
```

---

### Clear Sessions

Revoke all active sessions for a user, forcing re-authentication on all devices.

```http
DELETE /api/users/:id/sessions
```

**Required Scope:** `users:delete`

**Request:**

```ts title="clear-sessions.ts"
const response = await fetch(
  "https://auth.example.com/api/users/usr_abc123/sessions",
  {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  }
)
```

**Response:**

```json title="clear-sessions-response.json"
{
  "revoked_count": 5
}
```

---

### Force Password Reset

Require a user to change their password on next login. This is useful for security compliance, after a password breach, or when onboarding users with temporary passwords.

```http
POST /api/users/:id/force-password-reset
```

**Required Scope:** `users:write`

**Request:**

```ts title="force-password-reset.ts"
const response = await fetch(
  "https://auth.example.com/api/users/usr_abc123/force-password-reset",
  {
    method: "POST",
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  }
)
```

**Response:**

```json title="force-password-reset-response.json"
{
  "id": "usr_abc123",
  "tenant_id": "tenant_001",
  "email": "alice@example.com",
  "name": "Alice Smith",
  "status": "active",
  "password_reset_required": true,
  "created_at": 1699574400000,
  "updated_at": 1699920000000,
  "last_login_at": 1699660800000,
  "deleted_at": null
}
```

**Use Cases:**
- Security breach response - force all affected users to reset passwords
- Compliance requirements - periodic password rotation policies
- New user onboarding - admin creates user with temporary password
- Account recovery - helpdesk triggers reset for locked-out user

:::note[Password Flow]
When `password_reset_required` is `true`, the password provider will redirect the user to the password change flow after successful authentication. The flag is automatically cleared after the password is changed.
:::

---

### Clear Password Reset Flag

Clear the password reset requirement for a user (e.g., if set by mistake).

```http
DELETE /api/users/:id/force-password-reset
```

**Required Scope:** `users:write`

**Request:**

```ts title="clear-password-reset.ts"
const response = await fetch(
  "https://auth.example.com/api/users/usr_abc123/force-password-reset",
  {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  }
)
```

**Response:**

```json title="clear-password-reset-response.json"
{
  "id": "usr_abc123",
  "tenant_id": "tenant_001",
  "email": "alice@example.com",
  "name": "Alice Smith",
  "status": "active",
  "password_reset_required": false,
  "created_at": 1699574400000,
  "updated_at": 1699920000000,
  "last_login_at": 1699660800000,
  "deleted_at": null
}
```

---

## Error Codes

All errors follow the OAuth 2.0 format with an `error` code and `error_description`.

| Error Code | HTTP Status | Description |
|------------|-------------|-------------|
| `validation_error` | 400 | Request validation failed (includes `field`) |
| `user_not_found` | 404 | User does not exist or is deleted |
| `identity_not_found` | 404 | Identity does not exist |
| `email_already_exists` | 409 | Email is already registered to another user |
| `identity_already_linked` | 409 | Identity is already linked to a user |
| `user_suspended` | 403 | Operation not allowed on suspended user |
| `user_deleted` | 403 | Operation not allowed on deleted user |
| `server_error` | 500 | Unexpected internal error |

### Validation Error Fields

| Field | Possible Issues |
|-------|-----------------|
| `email` | Required, invalid format, exceeds 255 characters |
| `id` | Invalid user ID format |
| `tenant` | Tenant context is required |

---

## Database Schema

The Users API stores data in these D1 tables:

```sql title="schema.sql"
-- Users table
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    tenant_id TEXT NOT NULL,
    email TEXT NOT NULL,
    name TEXT,
    metadata TEXT,  -- JSON object
    status TEXT NOT NULL DEFAULT 'active',
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    last_login_at INTEGER,
    deleted_at INTEGER,
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);

-- Unique email per tenant (only for non-deleted users)
CREATE UNIQUE INDEX idx_users_tenant_email
    ON users(tenant_id, email) WHERE deleted_at IS NULL;

-- Query indexes
CREATE INDEX idx_users_tenant ON users(tenant_id);
CREATE INDEX idx_users_status ON users(tenant_id, status);
CREATE INDEX idx_users_created ON users(tenant_id, created_at);
CREATE INDEX idx_users_updated ON users(tenant_id, updated_at);
CREATE INDEX idx_users_email ON users(email);

-- User identities table
CREATE TABLE user_identities (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    tenant_id TEXT NOT NULL,
    provider TEXT NOT NULL,
    provider_user_id TEXT NOT NULL,
    provider_data TEXT,  -- JSON object
    created_at INTEGER NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- Unique identity per provider per tenant
CREATE UNIQUE INDEX idx_identities_provider
    ON user_identities(tenant_id, provider, provider_user_id);
CREATE INDEX idx_identities_user ON user_identities(user_id);
CREATE INDEX idx_identities_tenant_provider
    ON user_identities(tenant_id, provider);
```

### Key Constraints

1. **Email Uniqueness** - Emails are unique per tenant, but only for non-deleted users. Deleted users' emails can be reused.

2. **Identity Uniqueness** - A provider + provider_user_id combination can only exist once per tenant.

3. **Cascading Deletes** - When a user is hard-deleted (via direct SQL), their identities are automatically removed.

---

## SDK Reference

For server-side operations, you can use the `UserService` directly:

```ts title="user-service.ts"
import { UserServiceImpl } from "@openauthjs/openauth/user"
import { D1UserAdapter } from "@openauthjs/openauth/user"

const userService = new UserServiceImpl({
  storage: env.KV,
  d1Adapter: new D1UserAdapter({ db: env.DB }),
})
```

### Service Methods

```ts title="user-service-interface.ts"
interface UserService {
  // User CRUD
  createUser(tenantId: string, params: CreateUserParams): Promise<User>
  getUser(tenantId: string, userId: string): Promise<User | null>
  getUserWithIdentities(tenantId: string, userId: string): Promise<UserWithIdentities | null>
  getUserByEmail(tenantId: string, email: string): Promise<User | null>
  updateUser(tenantId: string, userId: string, params: UpdateUserParams): Promise<User>
  deleteUser(tenantId: string, userId: string): Promise<void>
  listUsers(tenantId: string, params?: ListUsersParams): Promise<ListUsersResponse>

  // User status
  suspendUser(tenantId: string, userId: string): Promise<SuspendUserResponse>
  unsuspendUser(tenantId: string, userId: string): Promise<User>
  revokeUserSessions(tenantId: string, userId: string): Promise<RevokeSessionsResponse>

  // Identity management
  getUserIdentities(tenantId: string, userId: string): Promise<UserIdentity[]>
  linkIdentity(tenantId: string, userId: string, identity: IdentityParams): Promise<UserIdentity>
  unlinkIdentity(tenantId: string, userId: string, identityId: string): Promise<void>

  // Login tracking
  updateLastLogin(tenantId: string, userId: string): Promise<void>
}
```

### Usage Examples

```ts title="service-examples.ts"
// Create user with metadata
const user = await userService.createUser("tenant_001", {
  email: "alice@example.com",
  name: "Alice Smith",
  metadata: { department: "Engineering" },
})

// List active users sorted by name
const { users, has_more, next_cursor } = await userService.listUsers("tenant_001", {
  status: "active",
  sort_by: "name",
  sort_order: "asc",
  limit: 25,
})

// Suspend user and revoke sessions
const { user: suspendedUser, revoked_sessions } = await userService.suspendUser(
  "tenant_001",
  "usr_abc123"
)

// Link a new identity
const identity = await userService.linkIdentity("tenant_001", "usr_abc123", {
  provider: "github",
  provider_user_id: "12345678",
  provider_data: { login: "alicesmith" },
})
```
